# User Management & Subscription Model Design

This document outlines a comprehensive, robust, and scalable user management and subscription system for the Lekhak AI Chrome Extension with integrated payment processing and usage tracking.

## ğŸ¯ System Overview

### **Business Flow**
```
Extension Installation â†’ User Registration â†’ 10 Free Uses â†’ Payment Required â†’ Subscription Management â†’ Unlimited/Limited Usage
```

### **Core Requirements**
1. **User Identification**: Unique tracking across extension installations
2. **Usage Tracking**: Monitor and limit API calls per user
3. **Subscription Management**: Handle multiple pricing tiers
4. **Payment Processing**: Secure payment handling with Stripe
5. **Real-time Validation**: Instant usage verification
6. **Failure Recovery**: Robust error handling and data consistency

## ğŸ—ï¸ Architecture Design

### **Tech Stack**
- **Database**: PostgreSQL (Supabase/PlanetScale for managed hosting)
- **Payment Gateway**: Stripe
- **API Layer**: Vercel Serverless Functions
- **Caching**: Redis (optional for high-scale)
- **Authentication**: Extension ID + Email mapping
- **Frontend**: React with existing OAuth system

### **System Components**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chrome Ext.    â”‚â”€â”€â”€â–¶â”‚   API Gateway   â”‚â”€â”€â”€â–¶â”‚   Database      â”‚
â”‚  (Client)       â”‚    â”‚  (Vercel)       â”‚    â”‚  (PostgreSQL)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚     Stripe      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚   (Payments)    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Database Schema Design

### **Core Tables Structure**

#### 1. **users** table
```sql
- id (UUID, Primary Key)
- email (VARCHAR, Unique)
- extension_id (VARCHAR, Unique) -- Generated by extension
- name (VARCHAR)
- profile_picture (TEXT)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)
- last_seen (TIMESTAMP)
- is_active (BOOLEAN)
```

#### 2. **subscription_plans** table
```sql
- id (UUID, Primary Key)
- name (VARCHAR) -- "Free", "Pro", "Unlimited"
- description (TEXT)
- price_monthly (DECIMAL)
- price_yearly (DECIMAL)
- hits_limit (INTEGER) -- -1 for unlimited
- features (JSONB)
- stripe_price_id_monthly (VARCHAR)
- stripe_price_id_yearly (VARCHAR)
- is_active (BOOLEAN)
- created_at (TIMESTAMP)
```

#### 3. **user_subscriptions** table
```sql
- id (UUID, Primary Key)
- user_id (UUID, Foreign Key)
- plan_id (UUID, Foreign Key)
- status (VARCHAR) -- "active", "cancelled", "expired", "past_due"
- billing_cycle (VARCHAR) -- "monthly", "yearly"
- stripe_subscription_id (VARCHAR)
- stripe_customer_id (VARCHAR)
- started_at (TIMESTAMP)
- current_period_start (TIMESTAMP)
- current_period_end (TIMESTAMP)
- cancelled_at (TIMESTAMP)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)
```

#### 4. **user_quotas** table
```sql
- id (UUID, Primary Key)
- user_id (UUID, Foreign Key, Unique)
- hits_used_today (INTEGER)
- hits_used_this_month (INTEGER)
- total_hits_used (INTEGER)
- daily_reset_at (TIMESTAMP)
- monthly_reset_at (TIMESTAMP)
- daily_limit (INTEGER) -- Cached from plan
- monthly_limit (INTEGER) -- Cached from plan
- updated_at (TIMESTAMP)
```

#### 5. **usage_logs** table
```sql
- id (UUID, Primary Key)
- user_id (UUID, Foreign Key)
- action_type (VARCHAR) -- "text_rewrite", "grammar_check"
- input_text_length (INTEGER)
- output_text_length (INTEGER)
- user_agent (TEXT)
- ip_address (INET)
- created_at (TIMESTAMP)
```

#### 6. **payment_transactions** table
```sql
- id (UUID, Primary Key)
- user_id (UUID, Foreign Key)
- subscription_id (UUID, Foreign Key)
- stripe_payment_intent_id (VARCHAR)
- amount (DECIMAL)
- currency (VARCHAR)
- status (VARCHAR) -- "succeeded", "failed", "pending"
- description (TEXT)
- metadata (JSONB)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)
```

## ğŸ”„ User Journey & System Flow

### **Phase 1: Extension Installation & First Use**
1. **Extension generates unique ID** on installation
2. **User uses extension** â†’ API call to check user status
3. **System creates user record** if not exists
4. **Quota initialized** with 10 free uses
5. **Usage tracked** in real-time

### **Phase 2: Free Tier Usage**
1. **Each API call** decrements free quota
2. **Real-time validation** before processing
3. **Usage logging** for analytics
4. **Warning notifications** at 8/10 uses

### **Phase 3: Upgrade Flow**
1. **Extension shows upgrade prompt** after 10 uses
2. **Redirect to /upgrade** with user identification
3. **Pricing page** with plan selection
4. **Stripe Checkout** integration
5. **Webhook handles** successful payment
6. **User quota updated** immediately

### **Phase 4: Subscription Management**
1. **Ongoing usage tracking** against subscription limits
2. **Automatic billing** via Stripe
3. **Plan upgrades/downgrades** handled via API
4. **Subscription cancellation** with grace period

## ğŸ’³ Pricing Plans Structure

### **Free Plan**
- **Price**: $0/month
- **Limits**: 10 uses per day
- **Features**: Basic text rewriting
- **Reset**: Daily at midnight UTC

### **Pro Plan**
- **Price**: $9.99/month or $99.99/year
- **Limits**: 1,000 uses per month
- **Features**: 
  - Advanced AI rewriting
  - Grammar checking
  - Tone adjustment
  - Priority support
- **Reset**: Monthly on billing date

### **Unlimited Plan**
- **Price**: $19.99/month or $199.99/year
- **Limits**: Unlimited usage
- **Features**:
  - All Pro features
  - API access
  - Custom integrations
  - Premium support
  - Early access to new features

## ğŸ”Œ API Endpoints Design

### **1. User Management**

#### `POST /api/users/identify`
```javascript
// Extension calls this on every use
{
  "extension_id": "unique-extension-id",
  "email": "user@example.com", // Optional, from OAuth
  "action_type": "text_rewrite"
}

// Response
{
  "success": true,
  "user_id": "uuid",
  "can_use": true,
  "hits_remaining": 5,
  "subscription_status": "free|pro|unlimited",
  "upgrade_url": "/upgrade?user_id=uuid"
}
```

#### `GET /api/users/{user_id}/quota`
```javascript
// Check current usage status
{
  "hits_used_today": 8,
  "hits_remaining": 2,
  "daily_limit": 10,
  "subscription_plan": "free",
  "next_reset": "2024-01-01T00:00:00Z"
}
```

### **2. Subscription Management**

#### `GET /api/plans`
```javascript
// Get available subscription plans
[
  {
    "id": "plan-uuid",
    "name": "Pro",
    "price_monthly": 9.99,
    "price_yearly": 99.99,
    "hits_limit": 1000,
    "features": ["Advanced AI", "Grammar Check"],
    "stripe_price_id": "price_xxx"
  }
]
```

#### `POST /api/subscriptions/create`
```javascript
// Create Stripe checkout session
{
  "user_id": "uuid",
  "plan_id": "plan-uuid",
  "billing_cycle": "monthly",
  "success_url": "https://lekhak.ai/success",
  "cancel_url": "https://lekhak.ai/upgrade"
}

// Response
{
  "checkout_url": "https://checkout.stripe.com/xxx",
  "session_id": "cs_xxx"
}
```

### **3. Payment Webhooks**

#### `POST /api/webhooks/stripe`
```javascript
// Stripe webhook handler
{
  "type": "invoice.payment_succeeded",
  "data": {
    "object": {
      "customer": "cus_xxx",
      "subscription": "sub_xxx",
      "amount_paid": 999
    }
  }
}
```

## ğŸ” Security & Performance Considerations

### **Security Measures**
1. **Extension ID Validation**: Unique, cryptographically secure IDs
2. **Rate Limiting**: API rate limits to prevent abuse
3. **Input Sanitization**: All user inputs validated and sanitized
4. **Webhook Verification**: Stripe webhook signature verification
5. **Database Encryption**: Sensitive data encrypted at rest
6. **HTTPS Only**: All communications over secure channels

### **Performance Optimizations**
1. **Database Indexing**: Optimized queries with proper indexes
2. **Connection Pooling**: Efficient database connection management
3. **Caching Strategy**: Redis for frequently accessed data
4. **Batch Operations**: Bulk usage logging for analytics
5. **CDN Integration**: Static assets served via CDN

### **Failure Recovery**
1. **Transaction Rollbacks**: Database consistency with transactions
2. **Retry Logic**: Automatic retry for failed API calls
3. **Fallback Mechanisms**: Graceful degradation for service outages
4. **Data Backup**: Regular automated backups
5. **Monitoring**: Real-time system health monitoring

## ğŸ“ˆ Analytics & Monitoring

### **Key Metrics to Track**
1. **User Metrics**:
   - Daily/Monthly Active Users
   - User retention rates
   - Free to paid conversion rate

2. **Usage Metrics**:
   - API calls per user
   - Feature usage distribution
   - Peak usage times

3. **Revenue Metrics**:
   - Monthly Recurring Revenue (MRR)
   - Customer Lifetime Value (CLV)
   - Churn rate by plan

4. **Technical Metrics**:
   - API response times
   - Error rates
   - System uptime

### **Monitoring Tools**
- **Application Performance**: Vercel Analytics
- **Database Performance**: Database provider monitoring
- **Payment Monitoring**: Stripe Dashboard
- **Error Tracking**: Sentry or similar
- **Uptime Monitoring**: Pingdom or UptimeRobot

## ğŸš€ Implementation Phases

### **Phase 1: Core Infrastructure** (Week 1-2)
- [ ] Database schema implementation
- [ ] Basic API endpoints for user management
- [ ] Extension ID generation and tracking
- [ ] Free tier quota management

### **Phase 2: Payment Integration** (Week 3-4)
- [ ] Stripe integration setup
- [ ] Pricing page implementation
- [ ] Checkout flow creation
- [ ] Webhook handling for payments

### **Phase 3: Subscription Management** (Week 5-6)
- [ ] Plan upgrade/downgrade logic
- [ ] Subscription status tracking
- [ ] Usage limit enforcement
- [ ] Customer portal integration

### **Phase 4: Enhancement & Optimization** (Week 7-8)
- [ ] Analytics implementation
- [ ] Performance optimization
- [ ] Advanced error handling
- [ ] Comprehensive testing

## ğŸ”§ Extension Integration Points

### **Extension Modifications Required**

#### 1. **User Identification**
```javascript
// Generate unique extension ID on install
const extensionId = crypto.randomUUID();
chrome.storage.local.set({ extensionId });

// Include in all API calls
const response = await fetch('/api/users/identify', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    extension_id: extensionId,
    action_type: 'text_rewrite'
  })
});
```

#### 2. **Usage Validation**
```javascript
// Check before processing
if (!response.can_use) {
  showUpgradePrompt(response.upgrade_url);
  return;
}

// Update UI with remaining uses
updateUsageCounter(response.hits_remaining);
```

#### 3. **Upgrade Flow**
```javascript
// Show upgrade prompt
function showUpgradePrompt(upgradeUrl) {
  chrome.tabs.create({ url: upgradeUrl });
}
```

## ğŸ“‹ Testing Strategy

### **Unit Tests**
- Database functions
- API endpoint logic
- Payment processing functions
- Quota calculation algorithms

### **Integration Tests**
- End-to-end user journey
- Payment flow testing
- Webhook handling verification
- Extension-to-API communication

### **Load Testing**
- Concurrent user simulation
- Database performance under load
- API response time benchmarks
- Payment processing reliability

## ğŸ¯ Success Metrics

### **Technical Success**
- 99.9% API uptime
- <200ms average response time
- Zero payment processing errors
- Accurate usage tracking (100% precision)

### **Business Success**
- 15% free-to-paid conversion rate
- <5% monthly churn rate
- 95% customer satisfaction score
- $50K+ Monthly Recurring Revenue in 6 months

This design provides a robust, scalable foundation for managing users and subscriptions while ensuring security, performance, and reliability at every level of the system.